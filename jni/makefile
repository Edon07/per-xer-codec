#include asn1/Makefile.am.libanscodec

.PHONY: all clean install

# Define a variable for classpath
CLASS_PATH = ../target/classes/

# Debug flags:
# -g3=compile with extra debugg infos. 
# -ggdbg3=include things like macro defenitions. 
# -O0=turn off optimizations.
# -Wall = With all warnings.
DEBUGFLAGS = -g3 -ggdb3 -O0 -Wall

# To deal with the fact that some OS's/Distro's don't define the JAVA_HOME variable, 
# figure out what os we are on, then use the appropriate method to find what it should be
# Then, use that to determine the two directories containing JNI headers 
JNI_INCLUDE=

UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
	LIB_EXT=so
	JAVA_HOME ?= /usr/lib/jvm/default-java
	JNI_INCLUDE+=-I"$(JAVA_HOME)/include"
	JNI_INCLUDE+=-I"$(JAVA_HOME)/include/linux"
endif
ifeq ($(UNAME_S),Darwin)
	LIB_EXT=dylib
	JAVA_HOME ?= $(shell /usr/libexec/java_home)
	JNI_INCLUDE+=-I"$(JAVA_HOME)/include"
	JNI_INCLUDE+=-I"$(JAVA_HOME)/include/darwin"
endif

# Expand the wildcard to get all of the autogenerated sources
autogen_targets := $(wildcard asn1/*.c)

# Both OSX and Linux will build the so
ALL_LIBS=libper-xer-codec.so
# OSX also needs to build the dylib
ifeq ($(UNAME_S),Darwin)
	ALL_LIBS+=libper-xer-codec.dylib
endif

all: $(ALL_LIBS)

install: all
	install -m 644 libper-xer-codec.* ../target/

clean:
	#rm $(ALL_LIBS) || exit 0

# Build the native header using the java class file
gov_dot_its_jpo_sdcsdw_asn1_perxercodec_Native.h : ../target/classes/gov/dot/its/jpo/sdcsdw/asn1/perxercodec/Native.class
	javah -classpath $(CLASS_PATH) gov.dot.its.jpo.sdcsdw.asn1.perxercodec.Native

# Build the shared object
libper-xer-codec.so: gov_dot_its_jpo_sdcsdw_asn1_perxercodec_Native.h gov_dot_its_jpo_sdcsdw_asn1_perxercodec_Native.c $(autogen_targets)
ifeq ($(UNAME_S),Darwin)
	./build-with-docker.sh
endif
ifeq ($(UNAME_S),Linux)
	@echo 'Building target: $@'
	@echo 'Invoking: GCC C Linker'
	gcc -shared -I"asn1" $(JNI_INCLUDE) $(CFLAGS) -fPIC -o "libper-xer-codec.$(LIB_EXT)" "$<" $(autogen_targets)
	@echo 'Finished building target: $@'
	@echo ' '
endif

libper-xer-codec.dylib: gov_dot_its_jpo_sdcsdw_asn1_perxercodec_Native.h gov_dot_its_jpo_sdcsdw_asn1_perxercodec_Native.c $(autogen_targets)
ifeq ($(UNAME_S),Darwin)
	@echo 'Building target: $@'
	@echo 'Invoking: GCC C Linker'
	gcc -shared -I"asn1" $(JNI_INCLUDE) $(CFLAGS) -o "libper-xer-codec.$(LIB_EXT)" gov_dot_its_jpo_sdcsdw_asn1_perxercodec_Native.c $(autogen_targets)
	#gcc -shared -I"asn1" $(JNI_INCLUDE) $(CFLAGS) -fPIC "$<" $(autogen_targets)
	@echo 'Finished building target: $@'
	@echo ' '
endif
ifeq ($(UNAME_S),Linux)
	@echo 'Cannot build OSX dylib on Linux'
	exit -1
endif

